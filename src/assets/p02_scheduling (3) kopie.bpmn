<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
                  xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
                  xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
                  xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
                  xmlns:camunda="http://camunda.org/schema/1.0/bpmn"
                  id="Definitions_SelectionOnly_Clean"
                  targetNamespace="http://poseidon/selection"
                  exporter="poseidon"
                  exporterVersion="1.0">

  <!-- manual trigger (optional) -->
  <bpmn:message id="Msg_RunSelection" name="Msg_RunSelection"/>

  <!-- ======================================================== -->
  <!-- ============ SELECTION_POLICY_RUNNER (ONLY) ============ -->
  <!-- ======================================================== -->
  <bpmn:process id="SELECTION_POLICY_RUNNER" name="Selection Policy Runner" isExecutable="true">

    <!-- Start events -->
    <bpmn:startEvent id="Start_Timer" name="Timer">
      <bpmn:timerEventDefinition>
        <!-- hourly; adjust as needed -->
        <bpmn:timeCycle>R/PT1H</bpmn:timeCycle>
      </bpmn:timerEventDefinition>
    </bpmn:startEvent>

    <bpmn:startEvent id="Start_Message" name="Run Selection Now">
      <bpmn:messageEventDefinition messageRef="Msg_RunSelection"/>
    </bpmn:startEvent>

    <!-- Merge starts -->
    <bpmn:exclusiveGateway id="G_Merge_Start" name="Merge Starts"/>

    <!-- Build selectionList -->
    <bpmn:serviceTask id="Task_EvaluateSelection"
                      name="Evaluate Selection (build selectionList)"
                      camunda:type="external"
                      camunda:topic="selection.evaluate"/>

    <!-- selectionList empty? -->
    <bpmn:exclusiveGateway id="G_SelectionEmpty" name="selectionList empty?"/>

    <!-- Nothing to schedule -->
    <bpmn:endEvent id="End_NoSelection" name="Nothing to schedule"/>

    <!-- Filter closed, dedup, idempotency -> preparedSelectionList -->
    <bpmn:serviceTask id="Task_PrepareList"
                      name="Prepare (filter closed &amp; dedup)"
                      camunda:type="external"
                      camunda:topic="selection.prepare"/>

    <!-- preparedSelectionList empty? -->
    <bpmn:exclusiveGateway id="G_PreparedEmpty" name="preparedSelectionList empty?"/>

    <!-- Enqueue executions (your scheduler picks them up) -->
    <bpmn:serviceTask id="Task_Enqueue"
                      name="Enqueue Execution"
                      camunda:type="external"
                      camunda:topic="execution.enqueue">
      <bpmn:multiInstanceLoopCharacteristics isSequential="false"
                                             camunda:collection="${preparedSelectionList}"
                                             camunda:elementVariable="item"/>
    </bpmn:serviceTask>

    <!-- Record run summary -->
    <bpmn:serviceTask id="Task_RecordRun"
                      name="Record Run Summary"
                      camunda:type="external"
                      camunda:topic="selection.record-run"/>

    <!-- Done -->
    <bpmn:endEvent id="End_Done" name="Done"/>

    <!-- Flows -->
    <bpmn:sequenceFlow id="F_S1" sourceRef="Start_Timer" targetRef="G_Merge_Start"/>
    <bpmn:sequenceFlow id="F_S2" sourceRef="Start_Message" targetRef="G_Merge_Start"/>
    <bpmn:sequenceFlow id="F_1" sourceRef="G_Merge_Start" targetRef="Task_EvaluateSelection"/>
    <bpmn:sequenceFlow id="F_2" sourceRef="Task_EvaluateSelection" targetRef="G_SelectionEmpty"/>

    <bpmn:sequenceFlow id="F_3a" sourceRef="G_SelectionEmpty" targetRef="End_NoSelection">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression"><![CDATA[${selectionList == null || selectionList.isEmpty()}]]></bpmn:conditionExpression>
    </bpmn:sequenceFlow>

    <bpmn:sequenceFlow id="F_3b" sourceRef="G_SelectionEmpty" targetRef="Task_PrepareList">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression"><![CDATA[${selectionList != null && !selectionList.isEmpty()}]]></bpmn:conditionExpression>
    </bpmn:sequenceFlow>

    <bpmn:sequenceFlow id="F_4" sourceRef="Task_PrepareList" targetRef="G_PreparedEmpty"/>

    <bpmn:sequenceFlow id="F_5a" sourceRef="G_PreparedEmpty" targetRef="End_NoSelection">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression"><![CDATA[${preparedSelectionList == null || preparedSelectionList.isEmpty()}]]></bpmn:conditionExpression>
    </bpmn:sequenceFlow>

    <bpmn:sequenceFlow id="F_5b" sourceRef="G_PreparedEmpty" targetRef="Task_Enqueue">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression"><![CDATA[${preparedSelectionList != null && !preparedSelectionList.isEmpty()}]]></bpmn:conditionExpression>
    </bpmn:sequenceFlow>

    <bpmn:sequenceFlow id="F_6" sourceRef="Task_Enqueue" targetRef="Task_RecordRun"/>
    <bpmn:sequenceFlow id="F_7" sourceRef="Task_RecordRun" targetRef="End_Done"/>

  </bpmn:process>

  <!-- Minimal DI so it renders in Modeler -->
  <bpmndi:BPMNDiagram id="Diagram_SelectionOnly">
    <bpmndi:BPMNPlane id="Plane_SelectionOnly" bpmnElement="SELECTION_POLICY_RUNNER">

      <!-- Shapes -->
      <bpmndi:BPMNShape id="S_Start_Timer" bpmnElement="Start_Timer">
        <dc:Bounds x="140" y="80" width="36" height="36"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="S_Start_Message" bpmnElement="Start_Message">
        <dc:Bounds x="140" y="160" width="36" height="36"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="S_G_Merge_Start" bpmnElement="G_Merge_Start" isMarkerVisible="true">
        <dc:Bounds x="240" y="120" width="50" height="50"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="S_Task_EvaluateSelection" bpmnElement="Task_EvaluateSelection">
        <dc:Bounds x="340" y="120" width="230" height="80"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="S_G_SelectionEmpty" bpmnElement="G_SelectionEmpty" isMarkerVisible="true">
        <dc:Bounds x="600" y="135" width="50" height="50"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="S_End_NoSelection" bpmnElement="End_NoSelection">
        <dc:Bounds x="700" y="80" width="36" height="36"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="S_Task_PrepareList" bpmnElement="Task_PrepareList">
        <dc:Bounds x="700" y="180" width="260" height="80"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="S_G_PreparedEmpty" bpmnElement="G_PreparedEmpty" isMarkerVisible="true">
        <dc:Bounds x="990" y="195" width="50" height="50"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="S_Task_Enqueue" bpmnElement="Task_Enqueue">
        <dc:Bounds x="1080" y="180" width="230" height="80"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="S_Task_RecordRun" bpmnElement="Task_RecordRun">
        <dc:Bounds x="1340" y="180" width="230" height="80"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="S_End_Done" bpmnElement="End_Done">
        <dc:Bounds x="1600" y="200" width="36" height="36"/>
      </bpmndi:BPMNShape>

      <!-- Edges -->
      <bpmndi:BPMNEdge id="E_F_S1" bpmnElement="F_S1">
        <di:waypoint x="176" y="98"/><di:waypoint x="240" y="98"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F_S2" bpmnElement="F_S2">
        <di:waypoint x="176" y="178"/><di:waypoint x="240" y="178"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F_1" bpmnElement="F_1">
        <di:waypoint x="290" y="145"/><di:waypoint x="340" y="160"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F_2" bpmnElement="F_2">
        <di:waypoint x="570" y="160"/><di:waypoint x="600" y="160"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F_3a" bpmnElement="F_3a">
        <di:waypoint x="625" y="160"/><di:waypoint x="718" y="98"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F_3b" bpmnElement="F_3b">
        <di:waypoint x="650" y="160"/><di:waypoint x="700" y="220"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F_4" bpmnElement="F_4">
        <di:waypoint x="960" y="220"/><di:waypoint x="990" y="220"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F_5a" bpmnElement="F_5a">
        <di:waypoint x="1015" y="220"/><di:waypoint x="718" y="98"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F_5b" bpmnElement="F_5b">
        <di:waypoint x="1040" y="220"/><di:waypoint x="1080" y="220"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F_6" bpmnElement="F_6">
        <di:waypoint x="1310" y="220"/><di:waypoint x="1340" y="220"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="E_F_7" bpmnElement="F_7">
        <di:waypoint x="1570" y="220"/><di:waypoint x="1600" y="218"/>
      </bpmndi:BPMNEdge>

    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>

</bpmn:definitions>
